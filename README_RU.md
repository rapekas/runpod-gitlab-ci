# CI/CD Pipeline для GPU на RunPod

Этот репозиторий содержит конфигурацию GitLab CI/CD, предназначенную для автоматизации развертывания, управления и удаления GPU-инстансов (подов) на [RunPod.io](https://runpod.io) для задач, таких как запуск больших языковых моделей (LLM) с помощью vLLM.

## Возможности

*   **Автоматическое развертывание:** Создает GPU-поды RunPod через API RunPod на основе настраиваемых параметров.
*   **Готово для LLM:** Настраивает поды для запуска LLM с использованием фреймворка vLLM.
*   **Этапы CI/CD:** Включает этапы для развертывания, перечисления, остановки, запуска и уничтожения подов непосредственно из GitLab CI/CD.
*   **Конфигурация через переменные:** Использует переменные GitLab CI/CD для легкой настройки спецификаций подов (тип GPU, модель, дисковое пространство и т.д.) и секретов (ключи API, токены).
*   **Вывод информации:** Предоставляет подробную информацию о созданном поде (стоимость, местоположение, спецификации) во время развертывания.

## Предварительные требования

1.  **Аккаунт GitLab и проект:** Вам нужна инстанция GitLab и проект для размещения файла `.gitlab-ci.yml`.
2.  **Аккаунт RunPod:** Активный аккаунт на [RunPod.io](https://runpod.io).
3.  **API-ключ RunPod:** API-ключ с полными правами из вашего аккаунта RunPod.
4.  **Токен Hugging Face:** Токен с [Hugging Face](https://huggingface.co/settings/tokens) (требуется при использовании закрытых (gated) моделей LLM).
5.  **SSH-ключи (Опционально):** Для прямого SSH-доступа к поду, если это необходимо.

## Настройка

1.  **Добавьте переменные в GitLab CI/CD:**
    В вашем проекте GitLab перейдите в `Settings` -> `CI/CD` -> `Variables`.
    Добавьте следующие переменные:
    *   `RUNPOD_API_KEY`: Ваш API-ключ RunPod (рекомендуется использовать Masked и Protected).
    *   `HG_TOKEN`: Ваш токен Hugging Face (рекомендуется использовать Masked и Protected).
    *   `RUNPOD_SSH_PUBLIC_KEYS`: Ваши публичные SSH-ключи для доступа к поду (если применимо, разделенные `\n`, если их несколько).
    *   `RUNPOD_SSH_PRIVATE_KEY`: Ваш приватный SSH-ключ, чтобы GitLab Runner мог подключиться к поду (рекомендуется использовать Masked и Protected).

2.  **Настройте `.gitlab-ci.yml`:**
    Просмотрите раздел `variables` в предоставленном файле `.gitlab-ci.yml`. При необходимости измените значения по умолчанию, такие как `HG_LLM`, `RUNPOD_GPU_TYPE`, `RUNPOD_TEMPLATE` и т.д., для вашего случая использования. Убедитесь, что указанный шаблон (`RUNPOD_TEMPLATE`) или образ (`RUNPOD_IMAGE`) поддерживают вашу целевую модель LLM и требования к GPU.

3.  **Теги раннера:**
    Убедитесь, что ваш GitLab Runner имеет теги `gpu` и `runpod` (или любые другие теги, которые вы указываете в `.gitlab-ci.yml`), чтобы он мог обрабатывать эти задания.

## Использование

1.  **Развертывание пода:** Вручную запустите задание `deploy_pod` в вашем CI/CD-пайплайне GitLab. Следите за логами для получения информации о создании пода и за консолью RunPod для отслеживания статуса развертывания.
2.  **Список подов:** Вручную запустите задание `list_all_pods`, чтобы увидеть статус и детали существующих подов.
3.  **Остановка/Запуск:** При необходимости вручную запустите задания `stop_pod` или `start_pod`.
4.  **Уничтожение пода:** Вручную запустите задание `destroy_pod`, чтобы завершить работу пода и прекратить начисление платы. Это критически важно для управления затратами.

## Важные замечания

*   **Стоимость:** Запуск GPU-подов влечет за собой расходы на RunPod.io. Всегда уничтожайте поды, когда они не используются.
*   **Ручные задания:** Все этапы установлены на `when: manual` для явного контроля. Запускайте их по мере необходимости.
*   **Закрытые (Gated) модели:** Убедитесь, что у вас есть доступ к указанной модели Hugging Face, и установите переменную `HG_TOKEN`, если модель закрыта (gated).
*   **Безопасность:** Храните конфиденциальную информацию, такую как API-ключи и токены, в безопасности, используя переменные GitLab CI/CD.

## Лицензия

Этот проект лицензирован по лицензии MIT.
